---
title: '(AWS시리즈9) 무중단 배포'
date: 2020-09-22 01:30:00
category: 'aws'
draft: false
---

# 무중단 배포

- awsseries8까지 Travis CI를 활용하여 배포 자동화 환경을 구축했다. 하지만 배포하는 동안 애플리케이션이 종료된다는 문제가 남아있다. 긴 기간은 아니지만, 새로운 Jar가 실행되기 전까진 기존 Jar를 종료시켜 놓기 때문에 `서비스가 중단`된다. 반면 24시간 서비스하는 네이버나 카카오톡 같은 경우 배포하는 동안 서비스가 정지되지는 않는다.

## 무중단 배포란?

- 예전에는 배포가 엄청나게 큰 일이었기 때문에 개발자 모두가 고생했다. 심지어 배포 후 치명적인 문제가 발견되었을 때 서비스를 정지해야만 가능한 경우라면 롤백조차 어려우므로 개발자들이 정말 많이 비효율적으로 일했다. 서비스 입장에서도 배포만 했다 하면 서비스가 정지돼야 하니 곤란한 상황이 많았다. 그래서 서비스를 정지하지 않고, 배포할 수 있는 방법들을 찾기 시작했고 이를 `무중단 배포`라고 한다. 몇 가지 방법이 있다.

  1. AWS에서 블루 그린(Blue-Green)무중단 배포
  2. 도커를 이용한 웹서비스 무중단 배포

  이외에도 L4 스위치를 이용한 무중단 배포 방법도 있지만, L4가 워낙 고가의 장비이다 보니 대형 인터넷 기업 외에는 쓸 일이 거의 없다. 여기서는 `엔진엑스를 이용한 무중단 배포`이다. `엔진엑스`는 웹서버, 리버스, 프록시, 캐싱, 로드 밸런싱, 미디어 스트리밍 등을 위한 오픈소스 소프트웨어다. 이전에 아파치(Apache)가 대세였전 자리를 완전히 빼앗은 가장 유명한 웹서버이자 오픈소스이다. 고성능 웹서버이기 때문에 대부분 서비스들이 현재는 엔진엑스를 사용하고 있다. 엔진엑스가 가지고 있는 여러 기능 중 `리버스 프록시`가 있다. 리버스 프록시란 엔진엑스가 외부의 요청을 받아 백엔드 서버로 요청을 전달하는 행위를 얘기한다. 리버스 프록시 서버(엔진엑스)는 요청을 전달하고, 실제 요청에 대한 처리는 뒷단의 웹 애플리케이션 서버들이 처리한다. 여기서는 이 리버스 프록시를 통해서 무중단 배포 환경을 구축할 예정. `엔진엑스를 이용한 무중단 배포를 하는 이유`는 간단하다. 가장 저렴하고 쉽기 때문.

  기존에 쓰던 EC2에 그대로 적용하면 되므로 배포를 위해 AWS EC2 인스턴스가 하나 더 필요하진 않다. 추가로 이 방식은 꼭 AWS와 같은 클라우드 인프라가 구축되어 있지 않아도 사용할 수 있는 범용적 방법. 즉, 개인 서버 혹은 사내 서버에서도 동일한 방식으로 구축할 수 있으므로 사용처가 많다.

  구조는 간단하다. 하나의 EC2 혹은 리눅스 서버에 엔진엑스 1대와 스프링 부트 Jar를 2대를 사용하는 것.

  - 엔진엑스는 80(http). 443(https) 포트를 할당한다.
  - 스프링 부트 1은 8081 포트로 실행한다.
  - 스프링 부트 2는 8082 포트로 실행한다.

  `엔진엑스 무중단 배포 1`의 운영 과정은 다음과 같다.

  1. 사용자는 서비스 주소로 접속한다. (80 혹은 443 포트).
  2. 엔진엑스는 사용자의 요청을 받아 현재 연결된 스프링 부트로 요청을 전달한다. (스프링 부트1 즉, 8081 포트로 요청을 전달한다고 가정)
  3. 스프링 부트2는 엔진엑스와 연결된 상태가 아니니 요청받지 못한다.

  1.1 버전으로 신규 배포가 필요하면, 엔진엑스와 연결되지 않은 스프링부트2(8082포트)로 배포한다.

  `엔진엑스 무중단 배포2`의 운영 과정은 다음과 같다.

  1. 배포하는 동안에도 서비스는 중단되지 않는다. (엔진엑스는 스프링 부트1을 바라보기 때문)
  2. 배포가 끝나고 정상적으로 스프링 부트2가 구동 중인지 확인한다.
  3. 스프링 부트2가 정상 구동 중이면 nginx reload 명령어를 통해 8081 대신에 8082를 바라보도록 한다.
  4. nginx reload는 0.1초 이내에 완료된다.

  `엔진엑스 무중단 배포3`의 운영 과정은 다음과 같다.

  1. 현재는 엔진엑스와 연결된 것이 스프링 부트2이다.
  2. 스프링 부트1의 배포가 끝났다면 엔진엑스가 스프링 부트1을 바라보도록 변경하고 nginx reload를 실행한다.
  3. 이후 요청부터는 엔진엑스가 스프링 부트1로 요청을 전달한다.

  이렇게 구성되면 전체 시스템 구조는 다음과 같다.
  ![](./images/awsseries8/process.png)
  기존 구조에서 EC2 내부의 구조만 변경된 것이다.

## 엔진엑스 설치와 스프링 부트 연동하기

- 엔진엑스 설치

  - EC2에 접속해서 다음 명령어로 엔진엑스 설치

    ```
    sudo yum install nginx
    ```

  - 설치가 완료되었으면 다음 명령어로 엔진엑스 실행

    ```
    sudo service nginx start
    ```

  - 엔진엑스가 잘 실행되었다면 다음과 같은 메시지를 확인 가능

    ```
    Starting nginx : [Ok]
    ```

  - 이제 외부에서 잘 노출되는지 확인

- 보안 그룹 추가
  - 먼저

참고 : 스프링 부트와 AWS로 혼자 구현하는 웹 서비스 - 이동욱
